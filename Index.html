<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard LoRa ‚Äì Protegido</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet (mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ----- SPLASH SCREEN ----- */
    #splash {
      position: fixed; inset: 0;
      background: url('https://i.ibb.co/fgXzxxM/VID-007-3.jpg') no-repeat center center fixed;
      background-size: cover;
      display: flex; justify-content: center; align-items: center;
      z-index: 99999;
    }
    #splash .splash-content {
      text-align: center; color: white; background: rgba(0,0,0,.6);
      padding: 40px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,.3);
      animation: fadeIn 2s ease-in-out;
    }
    #splash h1 { font-size: 3.5em; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,.5); }
    #splash p { font-size: 1.6em; margin-bottom: 30px; }
    #splash button {
      padding: 12px 30px; font-size: 1.3em; background: #28a745; color: #fff;
      border: none; border-radius: 8px; cursor: pointer; transition: background-color .3s ease;
    }
    #splash button:hover { background: #218838; }
    @keyframes fadeIn { 0%{opacity:0;transform:scale(.9)} 100%{opacity:1;transform:scale(1)} }

    /* ----- ESTILOS DEL DASHBOARD ----- */
    :root {
      --fondo-claro: #f4f4f4; --texto-claro: #333;
      --fondo-oscuro: #1e1e1e; --texto-oscuro: #eee;
      --card-claro: #fff; --card-oscuro: #2c2c2c;
    }
    body {
      font-family: Arial, sans-serif; margin: 0; padding: 0;
      background-color: var(--fondo-claro); color: var(--texto-claro);
      transition: background .3s, color .3s;
    }
    body.dark-mode { background-color: var(--fondo-oscuro); color: var(--texto-oscuro); }

    header {
      background: #222; color: #fff; padding: 1rem; text-align: center; position: relative;
    }
    #toggleTheme {
      position: absolute; top: 10px; right: 10px; background: #444; color: white; border: none;
      padding: 5px 10px; border-radius: 5px; cursor: pointer;
    }

    .config { padding: 1rem; background: #fff0e0; text-align: center; }
    body.dark-mode .config { background: #3b2f2f; }

    .umbral-row { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 1rem; margin-top: 1rem; }
    .umbral-row label { display: flex; align-items: center; gap: .3rem; font-weight: 500; }
    .umbral-row input { width: 70px; padding: 5px; text-align: right; }

    .cards { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; padding: 1rem; }
    .card {
      background: var(--card-claro); padding: 1rem; border-radius: 10px; min-width: 180px; text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,.1); transition: background .3s, color .3s;
    }
    body.dark-mode .card { background: var(--card-oscuro); box-shadow: 0 0 10px rgba(255,255,255,.05); }

    .critical { background-color: #ffdddd; border: 2px solid red; }
    body.dark-mode .critical { background-color: #733; }

    canvas { max-width: 100%; }

    #lastUpdate, #lastWhatsApp, #loginStatus { text-align: center; margin: 1rem; font-weight: bold; }

    #refreshBtn, #testBtn, #logoutBtn {
      display: block; margin: .5rem auto; padding: .5rem 1rem; font-size: 1rem; color: white;
      border: none; border-radius: 5px; cursor: pointer;
    }
    #refreshBtn { background: #008CBA; } #refreshBtn:hover { background: #006c9c; }
    #testBtn { background: #4CAF50; } #testBtn:hover { background: #3e8e41; }
    #logoutBtn { background: #c0392b; } #logoutBtn:hover { background: #992d22; }

    .notif {
      position: fixed; bottom: 20px; right: 20px; background: #4caf50; color: white;
      padding: 10px 20px; border-radius: 8px; font-weight: bold; z-index: 9999;
      box-shadow: 0 2px 8px rgba(0,0,0,.3); opacity: 0; transform: translateY(20px); transition: all .4s;
    }
    .notif.show { opacity: 1; transform: translateY(0); }

    /* ----- MAPA ----- */
    .map-card {
      background: var(--card-claro); margin: 16px; padding: 12px; border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,.1);
    }
    body.dark-mode .map-card { background: var(--card-oscuro); box-shadow: 0 0 10px rgba(255,255,255,.05); }
    #map { width: 100%; height: 320px; border-radius: 10px; }
    #mapStatus { text-align: center; margin-top: 8px; font-weight: 600; }
  </style>
</head>
<body>
  <!-- SPLASH -->
  <div id="splash">
    <div class="splash-content">
      <h1>BLADEN</h1>
      <p>20</p>
      <button onclick="ocultarSplash()">Entrar</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <header>
    <h1>üì° Dashboard LoRa ‚Äì Protegido</h1>
    <button id="toggleTheme">üåì Tema</button>
  </header>

  <div class="config">
    <div id="loginForm">
      üë§ Usuario: <input type="text" id="userInput" />
      üîë Contrase√±a: <input type="password" id="passInput" />
      <button onclick="verificarLogin()">Iniciar sesi√≥n</button>
    </div>

    <div id="loginStatus">--</div>

    <div id="panelConfig" style="display:none;">
      <label><input type="checkbox" id="whatsEnabled" onchange="guardarPreferenciaWhatsApp()" /> Activar WhatsApp</label>
      <div style="margin: .5rem;">‚è±Ô∏è Intervalo entre alertas (min):
        <input id="alertInterval" type="number" min="1" value="1" style="width:60px;" onchange="guardarIntervalo()">
      </div>

      <div class="umbral-row">
        <label>üå°Ô∏è Temp > <input id="thTemp" type="number" step="0.1"> ¬∞C</label>
        <label>üíß Hum > <input id="thHum" type="number" step="0.1"> %</label>
        <label>üöø Flujo < <input id="thFlow" type="number" step="0.1"> L/min</label>
        <label>üîã Volt < <input id="thVolt" type="number" step="0.1"> V</label>
        <button onclick="guardarUmbrales()">Guardar</button>
      </div>

      <!-- üîÜ CONTROL RELAY NUM√âRICO -->
      <div style="margin-top: 1.5rem; background: #ccc; padding: 1rem; border-radius: 8px;">
        <h3>üí° Control RELAY por LoRa (1/0)</h3>
        <button onclick="enviarComandoLED('1')" style="padding: 10px 20px; background: green; color: white; border-radius: 6px; border: none;">üîÜ Encender RELAY</button>
        <button onclick="enviarComandoLED('0')" style="padding: 10px 20px; background: red; color: white; border-radius: 6px; border: none; margin-left: 10px;">üí§ Apagar RELAY</button>
        <p>Estado actual: <strong id="ledEstado">--</strong></p>
        <p id="ledTimer" style="font-weight: bold;"></p>
      </div>

      <button id="testBtn" onclick="probarWhatsApp()">üì≤ Probar WhatsApp</button>
      <button id="logoutBtn" onclick="logout()">üö™ Cerrar sesi√≥n</button>
    </div>
  </div>

  <button id="refreshBtn" onclick="loadData()">üîÑ Actualizar ahora</button>
  <div id="lastUpdate">√öltima actualizaci√≥n: --</div>
  <div id="lastWhatsApp">√öltimo WhatsApp: --</div>
  <div class="cards" id="cardContainer"></div>
  <canvas id="chartCanvas" height="120"></canvas>

  <!-- MAPA -->
  <section class="map-card">
    <h2 style="text-align:center;margin:8px 0;">üó∫Ô∏è Ubicaci√≥n (GPS)</h2>
    <div id="map"></div>
    <div id="mapStatus">Sin coordenadas a√∫n‚Ä¶</div>
  </section>

  <div id="notif" class="notif"></div>

<script>
  /* ====== SPLASH ====== */
  function ocultarSplash() {
    const el = document.getElementById('splash');
    if (el) el.style.display = 'none';
  }
  // Sin auto-ocultar: el splash solo desaparece con el bot√≥n.

  /* ====== CONSTANTES ====== */
  const USER = "bladen";
  const PASS = "28433";
  const CHANNEL_ID = 3033478;
  const READ_API_KEY = "217V6P5DIT9GRVLA";
  const WRITE_API_KEY = "NAK04ON555J4UHDS";
  const LED_FIELD = 8;
  const notif = document.getElementById("notif");

  let ledTimer = 0;
  let timerInterval;
  let chart;

  const FIELDS = [
    { field: "field1", label: "üå°Ô∏è Temp (¬∞C)", color: "#ff6384" },
    { field: "field2", label: "üíß Humedad (%)", color: "#36a2eb" },
    { field: "field3", label: "üöø Flujo (L/min)", color: "#4bc0c0" },
    { field: "field4", label: "üîã Voltaje (V)", color: "#9966ff" },
    { field: "field5", label: "üí® Viento (km/h)", color: "#fcb045" }
  ];

  let umbrales = { temp: 30.0, hum: 70.0, flow: 0.0, volt: 3.0 };
  let intervaloMinutos = 1;
  const ultimosAlertas = {};

  /* ====== MAPA (Leaflet) ====== */
  let map, marker;
  function ensureMap() {
    if (!map) {
      map = L.map('map', { zoomControl: true }).setView([0, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
    }
  }
  function updateMap(lat, lon) {
    ensureMap();
    const status = document.getElementById('mapStatus');
    if (Number.isFinite(lat) && Number.isFinite(lon)) {
      if (!marker) marker = L.marker([lat, lon]).addTo(map);
      else marker.setLatLng([lat, lon]);
      map.setView([lat, lon], 14);
      status.textContent = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;
    } else {
      status.textContent = 'Sin coordenadas en el √∫ltimo feed.';
    }
  }

  /* ====== UI helpers ====== */
  function mostrarNotif(msg) {
    notif.textContent = msg;
    notif.classList.add("show");
    setTimeout(() => notif.classList.remove("show"), 3000);
  }

  /* ====== Login ====== */
  function verificarLogin() {
    const user = document.getElementById("userInput").value;
    const pass = document.getElementById("passInput").value;
    if (user === USER && pass === PASS) {
      localStorage.setItem("authOK", "1");
      habilitarConfiguracion(true);
      mostrarNotif("‚úÖ Sesi√≥n iniciada");
    } else {
      alert("‚ùå Credenciales incorrectas");
    }
  }
  function logout() {
    localStorage.removeItem("authOK");
    habilitarConfiguracion(false);
    mostrarNotif("üö™ Sesi√≥n cerrada");
  }
  function habilitarConfiguracion(activo) {
    document.getElementById("panelConfig").style.display = activo ? "block" : "none";
    document.getElementById("loginForm").style.display = activo ? "none" : "block";
    document.getElementById("logoutBtn").style.display = activo ? "inline-block" : "none";
    document.getElementById("loginStatus").innerText = activo ? "‚úÖ Sesi√≥n iniciada" : "--";
  }

  /* ====== Preferencias ====== */
  function guardarUmbrales() {
    umbrales.temp = parseFloat(document.getElementById("thTemp").value);
    umbrales.hum  = parseFloat(document.getElementById("thHum").value);
    umbrales.flow = parseFloat(document.getElementById("thFlow").value);
    umbrales.volt = parseFloat(document.getElementById("thVolt").value);
    localStorage.setItem("umbrales", JSON.stringify(umbrales));
    mostrarNotif("üíæ Umbrales guardados");
    loadData();
  }
  function cargarUmbrales() {
    const u = JSON.parse(localStorage.getItem("umbrales"));
    if (u) umbrales = u;
    document.getElementById("thTemp").value = umbrales.temp;
    document.getElementById("thHum").value = umbrales.hum;
    document.getElementById("thFlow").value = umbrales.flow;
    document.getElementById("thVolt").value = umbrales.volt;
  }
  function guardarPreferenciaWhatsApp() {
    const estado = document.getElementById("whatsEnabled").checked;
    localStorage.setItem("whatsEnabled", estado ? "1" : "0");
    mostrarNotif(estado ? "üì≤ WhatsApp activado" : "üîï WhatsApp desactivado");
  }
  function cargarPreferenciaWhatsApp() {
    const enabled = localStorage.getItem("whatsEnabled") === "1";
    document.getElementById("whatsEnabled").checked = enabled;
    return enabled;
  }
  function guardarIntervalo() {
    intervaloMinutos = parseInt(document.getElementById("alertInterval").value);
    localStorage.setItem("alertInterval", intervaloMinutos);
    mostrarNotif("üíæ Intervalo guardado");
  }
  function cargarIntervalo() {
    const val = parseInt(localStorage.getItem("alertInterval"));
    intervaloMinutos = isNaN(val) ? 1 : val;
    document.getElementById("alertInterval").value = intervaloMinutos;
  }

  /* ====== WhatsApp ====== */
  function enviarWhatsApp(msg) {
    const url = `https://api.callmebot.com/whatsapp.php?phone=+5212311560234&text=${encodeURIComponent(msg)}&apikey=4036182`;
    fetch(url)
      .then(() => { actualizarUltimoWhatsApp(); mostrarNotif("‚úÖ WhatsApp enviado"); })
      .catch(() => { actualizarUltimoWhatsApp(); mostrarNotif("‚ö†Ô∏è WhatsApp con error"); });
  }
  function probarWhatsApp() { enviarWhatsApp("üì° Prueba de notificaci√≥n desde el Dashboard LoRa"); }
  function actualizarUltimoWhatsApp() {
    const ahora = new Date().toLocaleString("es-MX");
    document.getElementById("lastWhatsApp").innerText = "√öltimo WhatsApp: " + ahora;
    localStorage.setItem("ultimoWhatsApp", ahora);
  }
  function cargarUltimoWhatsApp() {
    const t = localStorage.getItem("ultimoWhatsApp") || "--";
    document.getElementById("lastWhatsApp").innerText = "√öltimo WhatsApp: " + t;
  }

  /* ====== LED ====== */
  async function enviarComandoLED(valor) {
    if (ledTimer > 0) { mostrarNotif("‚è≥ Espera antes de enviar otro comando"); return; }
    const url = `https://api.thingspeak.com/update?api_key=${WRITE_API_KEY}&field${LED_FIELD}=${valor}&status=${Date.now()}`;
    try {
      const res = await fetch(url);
      const id = await res.text();
      if (parseInt(id) > 0) { mostrarNotif(`‚úÖ LED: comando ${valor} enviado`); iniciarTemporizador(); leerEstadoLED(); }
      else { mostrarNotif("‚ùå Error al enviar comando"); }
    } catch { mostrarNotif("‚ùå Error de red"); }
  }
  function iniciarTemporizador() {
    ledTimer = 15; actualizarTemporizador();
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      ledTimer--; actualizarTemporizador();
      if (ledTimer <= 0) { clearInterval(timerInterval); document.getElementById("ledTimer").textContent = ""; }
    }, 1000);
  }
  function actualizarTemporizador() {
    document.getElementById("ledTimer").textContent = `‚è≥ Espera ${ledTimer}s para nuevo comando`;
  }
  async function leerEstadoLED() {
    try {
      const res = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/${LED_FIELD}/last.txt?api_key=${READ_API_KEY}`);
      const val = await res.text();
      const estado = val.trim() === "1" ? "ENCENDIDO" : val.trim() === "0" ? "APAGADO" : val;
      document.getElementById("ledEstado").textContent = estado;
    } catch { document.getElementById("ledEstado").textContent = "Error"; }
  }

  /* ====== Datos + Gr√°fica + Mapa ====== */
  async function loadData() {
    try {
      const res = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=60`);
      const data = await res.json();
      const feeds = data.feeds || [];
      const last = feeds[feeds.length - 1];

      if (last) {
        document.getElementById("lastUpdate").innerText = "√öltima actualizaci√≥n: " + new Date(last.created_at).toLocaleString("es-MX");
      }

      // Tarjetas
      const cardContainer = document.getElementById("cardContainer");
      cardContainer.innerHTML = "";
      if (last) {
        FIELDS.forEach((f, i) => {
          const valNum = parseFloat(last[f.field]);
          const val = isNaN(valNum) ? "--" : valNum.toFixed(1);
          let isCritical = false;
          if (i === 0 && valNum > umbrales.temp) isCritical = true;
          if (i === 1 && valNum > umbrales.hum)  isCritical = true;
          if (i === 2 && valNum < umbrales.flow) isCritical = true;
          if (i === 3 && valNum < umbrales.volt) isCritical = true;

          const ahora = Date.now();
          const clave = f.field;
          if (isCritical && (!ultimosAlertas[clave] || ahora - ultimosAlertas[clave] > intervaloMinutos * 60000)) {
            ultimosAlertas[clave] = ahora;
            if (document.getElementById("whatsEnabled").checked) {
              enviarWhatsApp(`‚ö†Ô∏è Alerta: ${f.label} fuera de rango: ${val}`);
            }
          }

          const card = document.createElement("div");
          card.className = "card" + (isCritical ? " critical" : "");
          card.innerHTML = `<h2>${f.label}</h2><p style="font-size:1.4em;">${val}</p>`;
          cardContainer.appendChild(card);
        });
      }

      // Gr√°fica
      if (chart) chart.destroy();
      const labels = feeds.map(x => new Date(x.created_at).toLocaleTimeString());
      const datasets = FIELDS.map(f => ({
        label: f.label,
        data: feeds.map(x => parseFloat(x[f.field])),
        borderColor: f.color, fill: false, tension: 0.1
      }));
      chart = new Chart(document.getElementById("chartCanvas"), {
        type: "line",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } },
          scales: {
            x: { ticks: { color: document.body.classList.contains("dark-mode") ? "#eee" : "#333" } },
            y: { ticks: { color: document.body.classList.contains("dark-mode") ? "#eee" : "#333" } }
          }
        }
      });

      // ---- Geo desde field6 (lat) y field7 (lon) ----
      const lat = last ? parseFloat(last.field6) : NaN;
      const lon = last ? parseFloat(last.field7) : NaN;
      updateMap(lat, lon);

    } catch (e) {
      console.error("Error cargando datos", e);
    }
  }

  /* ====== Tema ====== */
  function toggleTheme() {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("modoOscuro", document.body.classList.contains("dark-mode") ? "1" : "0");
    loadData(); // recargar gr√°fico con colores de ejes
  }
  function cargarTema() {
    if (localStorage.getItem("modoOscuro") === "1") {
      document.body.classList.add("dark-mode");
    }
  }

  /* ====== Inicializaci√≥n ====== */
  cargarTema();
  cargarUmbrales();
  cargarIntervalo();
  cargarPreferenciaWhatsApp();
  cargarUltimoWhatsApp();
  if (localStorage.getItem("authOK") === "1") habilitarConfiguracion(true);
  document.getElementById("toggleTheme").addEventListener("click", toggleTheme);
  leerEstadoLED();
  setInterval(leerEstadoLED, 10000);
  loadData();
  setInterval(loadData, 30000);
</script>
</body>
</html>
